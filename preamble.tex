% === color ===

\usepackage[dvipsnames,table]{xcolor}

\definecolor{myPurple}{HTML}{CDC1FF}

% ref: https://latexcolor.com/
\definecolor{hotpink}{rgb}{1.0, 0.41, 0.71}
\definecolor{carnationpink}{rgb}{1.0, 0.65, 0.79}
\definecolor{deeppink}{rgb}{1.0, 0.08, 0.58}
\definecolor{capri}{rgb}{0.0, 0.75, 1.0}
\definecolor{rosepink}{rgb}{1.0, 0.4, 0.8}
\definecolor{princetonorange}{rgb}{1.0, 0.56, 0.0}
\definecolor{lavendermagenta}{rgb}{0.93, 0.51, 0.93}
\definecolor{malachite}{rgb}{0.04, 0.85, 0.32}
\definecolor{lawngreen}{rgb}{0.49, 0.99, 0.0}
\definecolor{periwinkle}{rgb}{0.8, 0.8, 1.0}
\definecolor{lightslategray}{rgb}{0.47, 0.53, 0.6}
\definecolor{robineggblue}{rgb}{0.0, 0.8, 0.8}
\definecolor{rosebonbon}{rgb}{0.98, 0.26, 0.62}
\definecolor{airforceblue}{rgb}{0.36, 0.54, 0.66}
\definecolor{columbiablue}{rgb}{0.61, 0.87, 1.0}
\definecolor{magnolia}{rgb}{0.97, 0.96, 1.0}

% === extend ===

\usepackage{xparse}%オプション（省略可能引数）をもつコマンド作成

% === math ===

\usepackage{amsthm} % 定理環境とQEDコマンド
\renewcommand{\qedsymbol}{\textcolor{gray}{$\blacksquare$}}

\usepackage{mathtools}
% 別の場所で参照する数式以外は番号が付かないように
\mathtoolsset{showonlyrefs=true}

% 数学モードに変更することなくギリシャ文字を使う
% （これがないと謎にエラーになる）
\usepackage{textgreek}

% 約分のためのキャンセル線
\usepackage[thicklines]{cancel}
\renewcommand{\CancelColor}{\color{Rhodamine}}

\usepackage{physics}
\usepackage{braket}

\DeclareMathOperator{\Arg}{Arg}

\newcommand{\icvec}[1]{% inline column vector
  \left(\begin{smallmatrix}#1\end{smallmatrix}\right)%
}
\newcommand{\irvec}[1]{% inline row vector
  \begin{smallmatrix}(#1)\end{smallmatrix}%
}

% === font ===

\usepackage[T1]{fontenc}

% normal font, math font
%\usepackage[light,math]{anttor}
\usepackage{gfsartemisia}

% monospace font
\usepackage[scaled]{beramono}

% === layout ===

% \section の前に改ページを挿入（ただし、\chapter 直後は除外）
% \newif\ifafterchapter
% \afterchaptertrue % 初期状態は true に設定
% \AddToHook{cmd/section/before}{\ifafterchapter\global\afterchapterfalse\else\clearpage\fi}
% \AddToHook{cmd/chapter/before}{\global\afterchaptertrue} % \chapter の後でフラグをリセット

\usepackage{setspace} % 行間調整用
\usepackage{leading}

\usepackage[margin=15truemm,top=20truemm,headsep=10truemm]{geometry} % 余白
\renewcommand{\baselinestretch}{1.5} % 行間

\setlength{\parindent}{0pt} % 段落始めでの字下げをしない

\usepackage{here} % figure環境のHオプション（画像を強制的にその場に表示する）を提供
\usepackage{caption}

% figure環境内で図の\captionを、table環境内で表の\captionを使う
% ref: http://tony.in.coocan.jp/latex/index.html#captype
\makeatletter%% プリアンブルで定義する場合は必須
\newcommand{\figcap}[1]{\def\@captype{figure}\caption{#1}}
\newcommand{\tblcap}[1]{\def\@captype{table}\caption{#1}}
\newcommand{\figcapstar}[1]{\def\@captype{figure}\caption*{#1}}
\newcommand{\tblcapstar}[1]{\def\@captype{table}\caption*{#1}}
\makeatother%% プリアンブルで定義する場合は必須

\usepackage{enumitem}
\usepackage{wrapstuff} % 回り込み

\usepackage{awesomebox}
\newenvironment{supplnote}{
  \begin{awesomeblock}{1pt}{\faPaw}{lightgray}
    \small
    }{
  \end{awesomeblock}
}

% === tikz ===

\usepackage[dvipdfmx]{graphicx}

\usepackage{pgfplots}
\pgfplotsset{compat=1.10}
\usepgfplotslibrary{fillbetween}

\usepackage{tikz} %図を描く
\usetikzlibrary{
  positioning,
  intersections,
  calc,
  arrows.meta,
  math,
  angles,
  quotes,
  bending,
  3d,
  decorations.pathmorphing,
  decorations.pathreplacing,
  decorations.footprints,
  patterns,
  shadows,
  shapes.geometric,
  spy,
  fit
}
\tikzstyle{axis}=[->, >=Stealth]
\tikzstyle{vector}=[->,>=Stealth,very thick, line cap=round]
\tikzstyle{auxline}=[dashed, thick] % 補助線
\tikzstyle{plotline}=[blue,very thick] % グラフ
\tikzstyle{zy-plane}=[canvas is zy plane at x=0]
\tikzstyle{xz-plane}=[canvas is xz plane at y=0]
\tikzstyle{xy-plane}=[canvas is xy plane at z=0]

\usepackage{tikz-3dplot}

\usepackage[edges]{forest} % 樹形図

\usepackage{witharrows} % 数式の間に矢印で説明を入れる
\usepackage{annotate-equations}

\usepackage{nl-interval} % 数直線上の区間を描く

\usepackage[outline]{contour} % 文字の縁取り

\usepackage{froufrou} % セクションを区切る装飾
\setfroufrou{dinkus}

\usepackage{halloweenmath}

\usepackage{nicematrix}

% === draft ===

\usepackage{lipsum} % デバッグ用のダミーテキスト

\usepackage{zebra-goodies} % TODOなどの注釈

\usepackage{mindflow} % 仮書きであることを示す

% === tcolorbox ===

\usepackage{tcolorbox}
\tcbuselibrary{listings,breakable,xparse,skins,hooks,theorems}

\newcommand{\titlegap}{\quad\\[0.1cm]}

\DeclareTColorBox{definition}{m O{} }%
{
  enhanced,
  colframe=white,
  colback=magnolia!20!white,
  coltitle=Cerulean!60!black,
  fonttitle=\bfseries,
  fontupper=\leading{0.5cm}, % line-height
  breakable=true,
  extras unbroken and last={drop small lifted shadow},
  underlay unbroken={
      \begin{tcbclipinterior}
        \shade[inner color=cyan!80!magnolia,outer color=magnolia!10!white] (interior.north east) circle (2cm);
        \draw[help lines,step=0.5cm,magnolia!80!black,draw opacity=0.6,shift={(interior.north west)}] (interior.south west) grid (interior.north east);
      \end{tcbclipinterior}
    },
  underlay first={
      \begin{tcbclipinterior}
        \shade[inner color=cyan!80!magnolia,outer color=magnolia!10!white] (interior.north east) circle (2.5cm);
        \draw[help lines,step=0.5cm,magnolia!80!black,draw opacity=0.6,shift={(interior.north west)}] (interior.south west) grid (interior.north east);
      \end{tcbclipinterior}},
  underlay last={
      \begin{tcbclipinterior}
        \draw[help lines,step=0.5cm,magnolia!80!black,draw opacity=0.6,shift={(interior.north west)}] (interior.south west) grid (interior.north east);
      \end{tcbclipinterior}
    },
  title={\faGraduationCap\hspace{0.1em} #1},
  detach title,
  before upper={\tcbtitle\quad},
  bottom=0.5cm,
  top=0.5cm,
  right=1.5cm,
  left=0.5cm,
  #2
}

%付箋環境~桃色バージョン~の定義
\DeclareTColorBox{theorem}{m O{} }%
{
  enhanced,
  colframe=white,
  colback=magnolia!20!white,
  coltitle=magenta!70!black,
  fonttitle=\bfseries,
  fontupper=\leading{0.5cm}, % line-height
  breakable,
  extras unbroken and last={drop small lifted shadow},
  underlay unbroken={
      \begin{tcbclipinterior}
        \shade[inner color=Rhodamine!80!magnolia,outer color=magnolia!10!white] (interior.north east) circle (2cm);
        \draw[help lines,step=0.5cm,magnolia!80!black,draw opacity=0.6,shift={(interior.north west)}] (interior.south west) grid (interior.north east);
      \end{tcbclipinterior}
    },
  underlay first={
      \begin{tcbclipinterior}
        \shade[inner color=Rhodamine!80!magnolia,outer color=magnolia!10!white] (interior.north east) circle (2.5cm);
        \draw[help lines,step=0.5cm,magnolia!80!black,draw opacity=0.6,shift={(interior.north west)}] (interior.south west) grid (interior.north east);
      \end{tcbclipinterior}
    },
  underlay last={
      \begin{tcbclipinterior}
        \draw[help lines,step=0.5cm,magnolia!80!black,draw opacity=0.6,shift={(interior.north west)}] (interior.south west) grid (interior.north east);
      \end{tcbclipinterior}
    },
  title={\faAnchor\hspace{0.1em} #1},
  detach title,
  before upper={\tcbtitle\quad},
  bottom=0.5cm,
  top=0.5cm,
  right=1.5cm,
  left=0.5cm,
  #2
}

\definecolor{ProofColor}{HTML}{D2DAFF}
\DeclareTColorBox{proof}{m}{%
  empty,
  title={#1},
  before title={Proof:~},
  attach boxed title to top left,
  boxed title style={
      empty,
      size=minimal,
      toprule=2pt,
      top=4pt,
      overlay={
          \draw[ProofColor,line width=2pt] ([yshift=-1pt]frame.north west)--([yshift=-1pt]frame.north east);
        }
    },
  coltitle=ProofColor!70!black,
  fonttitle=\bfseries,
  before=\par\medskip\noindent,
  parbox=false,
  boxsep=0pt,
  left=1em,
  right=1.5em,
  top=2.5em,
  bottom=1em,
  breakable,
  pad at break*=0mm,
  vfill before first,
  overlay unbroken={
      \draw[ProofColor,line width=1pt, dashed]
      ([yshift=-1pt]title.north east)
      --([xshift=-0.5pt,yshift=-1pt]title.north-|frame.east)
      --([xshift=-0.5pt]frame.south east)
      --(frame.south west);
    },
  overlay first={
      \draw[ProofColor,line width=1pt, dashed]([yshift=-1pt]title.north east)--([xshift=-0.5pt,yshift=-1pt]title.north-|frame.east)--([xshift=-0.5pt]frame.south east);
    },
  overlay middle={
      \draw[ProofColor,line width=1pt, dashed] ([xshift=-0.5pt]frame.north east)--([xshift=-0.5pt]frame.south east);
    },
  overlay last={
      \draw[ProofColor,line width=1pt, dashed] ([xshift=-0.5pt]frame.north east)--([xshift=-0.5pt]frame.south east)--(frame.south west);
    },%
}

\NewDocumentCommand{\patterntitle}{m}{
  \tcbox[
    enhanced,
    empty,
    boxsep=0pt,
    left=2pt,right=2pt,
    bottom=2pt,
    fonttitle=\bfseries,
    borderline south={1pt}{0pt}{ProofColor},
  ]{\textcolor{ProofColor}{\faStarAndCrescent}~#1}
}

\newenvironment{subpattern}[1]{
  \patterntitle{#1}
  \begin{quote}
    }{
  \end{quote}
}

\definecolor{mathLabelColor}{HTML}{FF87CA}
\NewDocumentCommand{\labelmath}{O{mathLabelColor!80!gray} O{red!10} m m}{
  \tcboxmath[
    enhanced,
    frame hidden,
    colback={#2},
    opacityback=0.6,
    title={#4},
    coltitle={#1},
    fonttitle=\bfseries,
    attach boxed title to top right={yshift=-0.5mm},
    boxed title style={empty, top=0mm, bottom=0mm}
  ]{#3}
}
% 余白少なめバージョン
\NewDocumentCommand{\fitLabelMath}{O{mathLabelColor!80!gray} O{red!10} O{0.6} m m}{
  \tcboxmath[
    enhanced,
    frame hidden,
    colback={#2},
    opacityback={#3},
    title={#5},
    coltitle={#1},
    fonttitle=\bfseries,
    left=1pt, right=1pt, top=1pt, bottom=1pt,
    attach boxed title to top center={yshift=-0.5mm},
    boxed title style={empty, top=0mm, bottom=0mm}
  ]{#4}
}

\NewDocumentCommand{\wavemath}{O{Rhodamine} m}{
  \tcboxmath[
    enhanced,
    frame hidden,
    interior hidden,
    size=minimal,
    bottom=1.1em,
    overlay={
        \draw[
          #1,
          thick,
          decorate,
          decoration={
              snake,               % 波線を引く
              amplitude=0.1em,     % 波線の振幅
              segment length=0.5em   % 波線の周期
            }
        ] ([yshift=0.7em]frame.south west) -- ([yshift=0.7em]frame.south east);
      }
  ]{#2}
}

\NewDocumentCommand{\wavelabelmath}{O{Rhodamine} m m}{
  \tcboxmath[
    enhanced,
    frame hidden,
    interior hidden,
    size=minimal,
    bottom=1.4em,
    overlay={
        \draw[
          #1,
          thick,
          decorate,
          decoration={
              snake,               % 波線を引く
              amplitude=0.1em,     % 波線の振幅
              segment length=0.5em   % 波線の周期
            }
        ] ([yshift=1.1em]frame.south west) -- ([yshift=1.1em]frame.south east)
        node[midway,below] {\bfseries #3};
      }
  ]{#2}
}

\definecolor{reviewBgColor}{HTML}{F9F9F9}
\definecolor{reviewFgColor}{HTML}{6886C5}
\newtcolorbox{review}{
  colback=reviewBgColor,
  colbacktitle=reviewFgColor,
  title=REVIEW,
  enhanced,
  attach boxed title to top left={yshift=-0.18cm,xshift=-0.5mm},
  boxed title style={
      tikz={rotate=4,transform shape},
      frame code={
          \draw[decorate, reviewFgColor,decoration={random steps,segment length=2mm,amplitude=0.6pt},fill=lightgray!20] (frame.south west) rectangle (frame.north east);
        }
    },
  frame code={
      \draw[decorate, reviewFgColor!50,decoration={random steps,segment length=2mm,amplitude=0.6pt}] (frame.north east) rectangle (frame.south west);
    },
}

\DeclareTColorBox{emphabox}{O{CadetBlue}}{%
  enhanced,
  breakable,
  interior hidden,
  frame hidden,
  grow sidewards by=-5mm,
  beforeafter skip=\baselineskip,
  frame code={%
      \draw[line width=1pt,#1] ($(frame.north west)!0.3!(frame.north east)$) -- (frame.north west) -- ($(frame.north west)!0.3!(frame.south west)$);
      \draw[line width=1pt,#1] ($(frame.south east)!0.3!(frame.south west)$) -- (frame.south east) -- ($(frame.south east)!0.3!(frame.north east)$);
      \draw[rosepink, fill=carnationpink, decorate, decoration={footprints,foot length=7pt,foot of=felis silvestris, foot angle=5, foot sep=2pt}] ($(frame.south east)!0.3!(frame.south west)$) -- (frame.south east);
    }
}

\DeclareTColorBox{spacebox}{}{%
  enhanced,
  breakable,
  interior hidden,
  frame hidden,
  grow sidewards by=-5mm,
  beforeafter skip=\baselineskip,
}

% === shotcut ===

\newcommand{\br}{\vskip\baselineskip}

% WIPマークを表示
\newcommand{\wip}{
  \begin{center}
    \vspace{1em}
    \scalebox{2.5}{\textcolor{lightgray}{$\xrightswishingghost{\text{Under construction}\ldots}$}}
  \end{center}
}

% definition,theorem環境内で用語を強調表示する
\NewDocumentCommand{\hl}{O{Orchid} m}{\hspace{0.25em}\textcolor{#1}{\textbf{#2}}\hspace{0.25em}}

% 本文中で用語を強調表示する
\newcommand{\keyword}[1]{\textcolor{Rhodamine}{\textbf{#1}}}

% 偶関数に背景色とラベルをつける
\NewDocumentCommand{\evenFn}{O{0.6} m}{
  \fitLabelMath[pink][pink][#1]{#2}{偶}
}
% 奇関数に背景色とラベルをつける
\NewDocumentCommand{\oddFn}{O{0.6} m}{
  \fitLabelMath[cyan][cyan!30][#1]{#2}{奇}
}

% 元の関数と導関数の区別をつける
\NewDocumentCommand{\origFn}{O{0.6} m}{
  \fitLabelMath[cyan][cyan!30][#1]{#2}{元の関数}
}
\NewDocumentCommand{\derivFn}{O{0.6} m}{
  \fitLabelMath[magenta!70][magenta!30][#1]{#2}{導関数}
}
